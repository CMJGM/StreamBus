{% extends 'base.html' %}

{% block content %}
<div class="container mt-4" style="max-width: 1000px;">
    <!-- Header con diseño moderno -->
    <div class="header-modern mb-4">
        <div class="d-flex align-items-center">
            <div class="icon-circle">
                <i class="bi bi-file-earmark-plus fs-3"></i>
            </div>
            <div class="ms-3">
                <h2 class="mb-0 fw-bold">Crear Nuevo Informe</h2>
                <p class="text-muted mb-0">Complete los datos del informe</p>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="informeForm">
        {% csrf_token %}

        <!-- Campos hidden -->
        {{ form.empleado }}
        {{ form.bus }}

        <!-- Card de Información General -->
        <div class="card card-modern mb-3">
            <div class="card-header-modern">
                <i class="bi bi-info-circle me-2"></i>Información General
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <!-- Título -->
                    <div class="col-12">
                        <label for="id_titulo" class="form-label fw-semibold">
                            <i class="bi bi-text-left text-primary me-1"></i> Título <span class="text-danger">*</span>
                        </label>
                        {{ form.titulo }}
                        {% if form.titulo.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.titulo.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Descripción -->
                    <div class="col-12">
                        <label for="id_descripcion" class="form-label fw-semibold">
                            <i class="bi bi-card-text text-success me-1"></i> Descripción <span class="text-danger">*</span>
                        </label>
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.descripcion.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Datos del Evento -->
        <div class="card card-modern mb-3">
            <div class="card-header-modern">
                <i class="bi bi-calendar-event me-2"></i>Datos del Evento
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <!-- Fecha y Hora -->
                    <div class="col-md-4">
                        <label for="id_fecha_hora" class="form-label fw-semibold">
                            <i class="bi bi-clock text-info me-1"></i> Fecha y Hora <span class="text-danger">*</span>
                        </label>
                        {{ form.fecha_hora }}
                        {% if form.fecha_hora.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.fecha_hora.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Sucursal -->
                    <div class="col-md-4">
                        <label for="id_sucursal" class="form-label fw-semibold">
                            <i class="bi bi-building text-warning me-1"></i> Sucursal <span class="text-danger">*</span>
                        </label>
                        {{ form.sucursal }}
                        {% if form.sucursal.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.sucursal.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i> Seleccione la sucursal
                        </small>
                    </div>

                    <!-- Origen -->
                    <div class="col-md-4">
                        <label for="id_origen" class="form-label fw-semibold">
                            <i class="bi bi-tags text-secondary me-1"></i> Origen <span class="text-danger">*</span>
                        </label>
                        {{ form.origen }}
                        {% if form.origen.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.origen.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Unidad y Personal -->
        <div class="card card-modern mb-4">
            <div class="card-header-modern">
                <i class="bi bi-people me-2"></i>Unidad y Personal Involucrado
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <!-- Bus (Obligatorio) -->
                    <div class="col-md-6">
                        <label for="id_bus_search" class="form-label fw-semibold">
                            <i class="bi bi-bus-front text-danger me-1"></i> Bus <span class="text-danger">*</span>
                        </label>
                        <div class="input-icon-wrapper">
                            {{ form.bus_search }}
                            <i class="bi bi-search input-icon"></i>
                        </div>
                        <div id="bus-results" class="autocomplete-results"></div>
                        <div id="bus-selected" class="selection-badge mt-2" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge-content">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Seleccionado:</strong> <span id="bus-selected-text"></span>
                                </span>
                                <button type="button" class="btn-badge-close" onclick="clearBus()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        {% if form.bus_search.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.bus_search.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-search"></i> Escriba al menos 3 caracteres de la ficha
                        </small>
                    </div>

                    <!-- Empleado (Opcional) -->
                    <div class="col-md-6">
                        <label for="id_empleado_search" class="form-label fw-semibold">
                            <i class="bi bi-person text-purple me-1"></i> Empleado <span class="text-muted small">(opcional)</span>
                        </label>
                        <div class="input-icon-wrapper">
                            {{ form.empleado_search }}
                            <i class="bi bi-search input-icon"></i>
                        </div>
                        <div id="empleado-results" class="autocomplete-results"></div>
                        <div id="empleado-selected" class="selection-badge mt-2" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge-content">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Seleccionado:</strong> <span id="empleado-selected-text"></span>
                                </span>
                                <button type="button" class="btn-badge-close" onclick="clearEmpleado()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        {% if form.empleado_search.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.empleado_search.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-search"></i> Escriba al menos 3 caracteres del legajo o nombre
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between align-items-center">
            <a href="{% url 'informes:lista_informes' %}" class="btn btn-modern-secondary">
                <i class="bi bi-arrow-left me-2"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-modern-primary">
                <i class="bi bi-check-lg me-2"></i> Guardar Informe
            </button>
        </div>
    </form>
</div>

<style>
    /* Header moderno */
    .header-modern {
        padding: 1.5rem 0;
    }

    .icon-circle {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    /* Cards modernos */
    .card-modern {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .card-modern:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    }

    .card-header-modern {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        color: #2c3e50;
        font-weight: 600;
        font-size: 1rem;
        padding: 1rem 1.5rem;
        border-bottom: 2px solid #dee2e6;
    }

    /* Inputs con iconos */
    .input-icon-wrapper {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        pointer-events: none;
    }

    .form-control {
        padding-right: 40px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    /* Badge de selección moderno */
    .selection-badge {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 2px solid #b1dfbb;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .badge-content {
        color: #155724;
        font-size: 0.9rem;
    }

    .btn-badge-close {
        background: transparent;
        border: none;
        color: #155724;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .btn-badge-close:hover {
        background: rgba(21, 87, 36, 0.1);
    }

    /* Autocomplete moderno */
    .autocomplete-results {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        max-height: 280px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        display: none;
        margin-top: 8px;
    }

    .autocomplete-results.show {
        display: block;
        animation: fadeInDown 0.2s ease;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .autocomplete-item {
        padding: 14px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
    }

    .autocomplete-item:hover {
        background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
        padding-left: 20px;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-loading,
    .autocomplete-no-results {
        padding: 16px;
        text-align: center;
        color: #6c757d;
    }

    /* Botones modernos */
    .btn-modern-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-modern-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
    }

    .btn-modern-secondary {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #495057;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-modern-secondary:hover {
        background: #e9ecef;
        border-color: #ced4da;
        color: #495057;
        transform: translateY(-2px);
    }

    /* Iconos de colores */
    .text-purple {
        color: #8b5cf6 !important;
    }

    /* Modo oscuro */
    @media (prefers-color-scheme: dark) {
        .card-modern {
            background-color: #1e2530;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .card-header-modern {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
            border-bottom-color: #34495e;
        }

        .form-control, .form-select {
            background-color: #2c3e50;
            border-color: #34495e;
            color: #ecf0f1;
        }

        .form-control:focus, .form-select:focus {
            background-color: #34495e;
            border-color: #667eea;
            color: #ecf0f1;
        }

        .autocomplete-results {
            background: #2c3e50;
            border-color: #34495e;
        }

        .autocomplete-item {
            border-bottom-color: #34495e;
            color: #ecf0f1;
        }

        .autocomplete-item:hover {
            background: linear-gradient(90deg, #34495e 0%, #3d556e 100%);
        }

        .selection-badge {
            background: linear-gradient(135deg, #1e4620 0%, #2d5a2e 100%);
            border-color: #2d5a2e;
        }

        .badge-content {
            color: #a5d6a7;
        }

        .btn-badge-close {
            color: #a5d6a7;
        }

        .btn-badge-close:hover {
            background: rgba(165, 214, 167, 0.1);
        }

        .btn-modern-secondary {
            background: #2c3e50;
            border-color: #34495e;
            color: #ecf0f1;
        }

        .btn-modern-secondary:hover {
            background: #34495e;
            border-color: #445566;
            color: #ecf0f1;
        }

        .autocomplete-loading,
        .autocomplete-no-results {
            color: #adb5bd;
        }
    }

    [data-bs-theme="dark"] .card-modern {
        background-color: #1e2530;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    [data-bs-theme="dark"] .card-header-modern {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #ecf0f1;
        border-bottom-color: #34495e;
    }

    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select {
        background-color: #2c3e50;
        border-color: #34495e;
        color: #ecf0f1;
    }

    [data-bs-theme="dark"] .form-control:focus,
    [data-bs-theme="dark"] .form-select:focus {
        background-color: #34495e;
        border-color: #667eea;
        color: #ecf0f1;
    }

    [data-bs-theme="dark"] .autocomplete-results {
        background: #2c3e50;
        border-color: #34495e;
    }

    [data-bs-theme="dark"] .autocomplete-item {
        border-bottom-color: #34495e;
        color: #ecf0f1;
    }

    [data-bs-theme="dark"] .autocomplete-item:hover {
        background: linear-gradient(90deg, #34495e 0%, #3d556e 100%);
    }

    [data-bs-theme="dark"] .selection-badge {
        background: linear-gradient(135deg, #1e4620 0%, #2d5a2e 100%);
        border-color: #2d5a2e;
    }

    [data-bs-theme="dark"] .badge-content {
        color: #a5d6a7;
    }

    [data-bs-theme="dark"] .btn-badge-close {
        color: #a5d6a7;
    }

    [data-bs-theme="dark"] .btn-badge-close:hover {
        background: rgba(165, 214, 167, 0.1);
    }

    [data-bs-theme="dark"] .btn-modern-secondary {
        background: #2c3e50;
        border-color: #34495e;
        color: #ecf0f1;
    }

    [data-bs-theme="dark"] .btn-modern-secondary:hover {
        background: #34495e;
        border-color: #445566;
        color: #ecf0f1;
    }

    [data-bs-theme="dark"] .autocomplete-loading,
    [data-bs-theme="dark"] .autocomplete-no-results {
        color: #adb5bd;
    }
</style>

<script>
    // Variables para controlar los timeouts de búsqueda
    let empleadoTimeout = null;
    let busTimeout = null;

    // URLs de los endpoints Ajax
    const buscarEmpleadosUrl = "{% url 'informes:buscar_empleados_ajax' %}";
    const buscarBusesUrl = "{% url 'informes:buscar_buses_ajax' %}";

    // Función para obtener el ID de la sucursal seleccionada
    function getSucursalId() {
        const sucursal = document.getElementById('id_sucursal');
        return sucursal ? sucursal.value : '';
    }

    // Búsqueda de empleados
    document.getElementById('id_empleado_search').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const resultsDiv = document.getElementById('empleado-results');

        if (empleadoTimeout) clearTimeout(empleadoTimeout);

        if (query.length < 3) {
            resultsDiv.classList.remove('show');
            return;
        }

        const sucursalId = getSucursalId();
        if (!sucursalId) {
            resultsDiv.innerHTML = '<div class="autocomplete-no-results"><i class="bi bi-exclamation-circle"></i> Primero seleccione una sucursal</div>';
            resultsDiv.classList.add('show');
            return;
        }

        resultsDiv.innerHTML = '<div class="autocomplete-loading"><i class="bi bi-hourglass-split"></i> Buscando...</div>';
        resultsDiv.classList.add('show');

        empleadoTimeout = setTimeout(() => {
            fetch(`${buscarEmpleadosUrl}?q=${encodeURIComponent(query)}&sucursal_id=${sucursalId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultsDiv.innerHTML = `<div class="autocomplete-no-results"><i class="bi bi-exclamation-circle"></i> ${data.error}</div>`;
                    } else if (data.empleados.length === 0) {
                        resultsDiv.innerHTML = '<div class="autocomplete-no-results"><i class="bi bi-inbox"></i> No se encontraron empleados</div>';
                    } else {
                        let html = '';
                        data.empleados.forEach(emp => {
                            html += `<div class="autocomplete-item" onclick="selectEmpleado(${emp.id}, '${emp.display.replace(/'/g, "\\'")}')">
                                <strong>${emp.legajo}</strong> - ${emp.nombre_completo}
                            </div>`;
                        });
                        resultsDiv.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultsDiv.innerHTML = '<div class="autocomplete-no-results"><i class="bi bi-x-circle"></i> Error al buscar</div>';
                });
        }, 300);
    });

    // Búsqueda de buses
    document.getElementById('id_bus_search').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const resultsDiv = document.getElementById('bus-results');

        if (busTimeout) clearTimeout(busTimeout);

        if (query.length < 3) {
            resultsDiv.classList.remove('show');
            return;
        }

        resultsDiv.innerHTML = '<div class="autocomplete-loading"><i class="bi bi-hourglass-split"></i> Buscando...</div>';
        resultsDiv.classList.add('show');

        busTimeout = setTimeout(() => {
            fetch(`${buscarBusesUrl}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultsDiv.innerHTML = `<div class="autocomplete-no-results"><i class="bi bi-exclamation-circle"></i> ${data.error}</div>`;
                    } else if (data.buses.length === 0) {
                        resultsDiv.innerHTML = '<div class="autocomplete-no-results"><i class="bi bi-inbox"></i> No se encontraron buses</div>';
                    } else {
                        let html = '';
                        data.buses.forEach(bus => {
                            html += `<div class="autocomplete-item" onclick="selectBus(${bus.id}, '${bus.display.replace(/'/g, "\\'")}')">
                                <strong>Ficha ${bus.ficha}</strong> - ${bus.dominio}
                            </div>`;
                        });
                        resultsDiv.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultsDiv.innerHTML = '<div class="autocomplete-no-results"><i class="bi bi-x-circle"></i> Error al buscar</div>';
                });
        }, 300);
    });

    // Seleccionar empleado
    function selectEmpleado(id, display) {
        document.getElementById('id_empleado').value = id;
        document.getElementById('id_empleado_search').value = display;
        document.getElementById('empleado-selected-text').textContent = display;
        document.getElementById('empleado-selected').style.display = 'block';
        document.getElementById('empleado-results').classList.remove('show');
    }

    // Seleccionar bus
    function selectBus(id, display) {
        document.getElementById('id_bus').value = id;
        document.getElementById('id_bus_search').value = display;
        document.getElementById('bus-selected-text').textContent = display;
        document.getElementById('bus-selected').style.display = 'block';
        document.getElementById('bus-results').classList.remove('show');
    }

    // Limpiar selección de empleado
    function clearEmpleado() {
        document.getElementById('id_empleado').value = '';
        document.getElementById('id_empleado_search').value = '';
        document.getElementById('empleado-selected').style.display = 'none';
    }

    // Limpiar selección de bus
    function clearBus() {
        document.getElementById('id_bus').value = '';
        document.getElementById('id_bus_search').value = '';
        document.getElementById('bus-selected').style.display = 'none';
    }

    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#id_empleado_search') && !e.target.closest('#empleado-results')) {
            document.getElementById('empleado-results').classList.remove('show');
        }
        if (!e.target.closest('#id_bus_search') && !e.target.closest('#bus-results')) {
            document.getElementById('bus-results').classList.remove('show');
        }
    });

    // Limpiar solo búsqueda de empleados cuando cambia la sucursal
    document.getElementById('id_sucursal').addEventListener('change', function() {
        clearEmpleado();
    });

    // Si hay valores iniciales (modo edición), mostrar los badges
    window.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('id_empleado').value) {
            const display = document.getElementById('id_empleado_search').value;
            if (display) {
                document.getElementById('empleado-selected-text').textContent = display;
                document.getElementById('empleado-selected').style.display = 'block';
            }
        }
        if (document.getElementById('id_bus').value) {
            const display = document.getElementById('id_bus_search').value;
            if (display) {
                document.getElementById('bus-selected-text').textContent = display;
                document.getElementById('bus-selected').style.display = 'block';
            }
        }
    });
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
   {% endif %}

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-2">
                <i class="bi bi-file-earmark-text"></i> Lista Completa de Informes
            </h2>
            <p class="text-muted mb-0">
                <span class="badge bg-secondary">{{ page_obj.paginator.count }} informe{{ page_obj.paginator.count|pluralize }}</span>
            </p>
        </div>
        <div>
            <a href="{% url 'informes:crear_informe' %}" class="btn btn-pastel-green">
                <i class="bi bi-plus-circle"></i> Crear Informe
            </a>
        </div>
    </div>

    <!-- Filtros -->
    <form method="get" class="mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-body p-3">
                <div class="row g-3 align-items-end">

                    <!-- Filtro por título -->
                    <div class="col-md-2">
                        <label for="filtro" class="form-label filter-label small mb-1">Título</label>
                        <input type="text" name="filtro" id="filtro" class="form-control form-control-sm"
                               value="{{ request.GET.filtro }}" placeholder="Buscar por título">
                    </div>

                    <!-- Filtro por número de ficha del bus -->
                    <div class="col-md-1">
                        <label for="numero_ficha" class="form-label filter-label small mb-1">N° Ficha</label>
                        <input type="text" name="numero_ficha" id="numero_ficha" class="form-control form-control-sm"
                            value="{{ request.GET.numero_ficha }}" placeholder="Ficha">
                    </div>

                    <!-- Filtro por legajo del empleado -->
                    <div class="col-md-1">
                        <label for="id_legajo" class="form-label filter-label small mb-1">Legajo</label>
                        <input type="text" name="legajo" id="id_legajo" class="form-control form-control-sm"
                               value="{{ request.GET.legajo }}" placeholder="Legajo">
                    </div>

                    <!-- Fecha Desde -->
                    <div class="col-md-2">
                        <label for="fecha_desde" class="form-label filter-label small mb-1">Desde</label>
                        <input type="datetime-local" name="fecha_desde" id="fecha_desde" class="form-control form-control-sm"
                               value="{{ request.GET.fecha_desde }}">
                    </div>

                    <!-- Fecha Hasta -->
                    <div class="col-md-2">
                        <label for="fecha_hasta" class="form-label filter-label small mb-1">Hasta</label>
                        <input type="datetime-local" name="fecha_hasta" id="fecha_hasta" class="form-control form-control-sm"
                               value="{{ request.GET.fecha_hasta }}">
                    </div>

                    <!-- Filtro por origen -->
                    <div class="col-md-2">
                        <label for="origen" class="form-label filter-label small mb-1">Origen</label>
                        <select name="origen" id="origen" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="Sistemas" {% if request.GET.origen == "Sistemas" %}selected{% endif %}>Sistemas</option>
                            <option value="Guardia" {% if request.GET.origen == "Guardia" %}selected{% endif %}>Guardia</option>
                            <option value="RRHH" {% if request.GET.origen == "RRHH" %}selected{% endif %}>RRHH</option>
                            <option value="Siniestros" {% if request.GET.origen == "Siniestros" %}selected{% endif %}>Siniestros</option>
                            <option value="Taller" {% if request.GET.origen == "Taller" %}selected{% endif %}>Taller</option>
                            <option value="Inspectores" {% if request.GET.origen == "Inspectores" %}selected{% endif %}>Inspectores</option>
                        </select>
                    </div>

                    <!-- Filtro por sucursal (solo habilitadas) -->
                    <div class="col-md-2">
                        <label for="sucursal" class="form-label filter-label small mb-1">Sucursal</label>
                        <select name="sucursal" id="sucursal" class="form-select form-select-sm">
                            <option value="">Todas</option>
                            {% for s in sucursales %}
                                <option value="{{ s.id }}" {% if request.GET.sucursal == s.id|stringformat:"s" %}selected{% endif %}>
                                    {{ s.abreviatura }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button type="submit" class="btn btn-pastel-blue btn-sm">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>

                    {% if request.GET.filtro or request.GET.fecha_desde or request.GET.fecha_hasta or request.GET.sucursal or request.GET.legajo or request.GET.numero_ficha or request.GET.origen  %}
                        <a href="{% url 'informes:lista_informes' %}" class="btn btn-pastel-red btn-sm">
                            <i class="bi bi-x-circle"></i> Limpiar Filtros
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>

    <!-- Aviso de filtros activos -->
    {% if request.GET.filtro or request.GET.fecha_desde or request.GET.fecha_hasta or request.GET.sucursal or request.GET.legajo or request.GET.numero_ficha or request.GET.origen  %}
        <div class="alert alert-info border-0 d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-info-circle me-2"></i>
                <strong>Filtros aplicados:</strong>
                {% if request.GET.filtro %} Título: "{{ request.GET.filtro }}"{% endif %}
                {% if request.GET.legajo %} | Legajo: {{ request.GET.legajo }}{% endif %}
                {% if request.GET.fecha_desde %} | Desde: {{ request.GET.fecha_desde }}{% endif %}
                {% if request.GET.fecha_hasta %} | Hasta: {{ request.GET.fecha_hasta }}{% endif %}
                {% if request.GET.origen %} | Origen: {{ request.GET.origen }} {% endif %}
                {% if request.GET.sucursal %}
                    {% for s in sucursales %}
                        {% if s.id|stringformat:"s" == request.GET.sucursal %}
                            | Sucursal: {{ s.abreviatura }}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if request.GET.numero_ficha %} | N° Ficha: {{ request.GET.numero_ficha }}{% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Tabla de informes -->
    <div class="card shadow-sm border-0 mt-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-header-pastel">
                    <tr>
                        <th class="text-center" style="width: 10%;">Nro. Informe</th>
                        <th style="width: 20%;">Título</th>
                        <th style="width: 18%;">Empleado</th>
                        <th class="text-center" style="width: 8%;">Bus</th>
                        <th class="text-center" style="width: 10%;">Sucursal</th>
                        <th class="text-center" style="width: 12%;">Fecha</th>
                        <th class="text-center" style="width: 22%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for informe in page_obj %}
                    <tr class="table-row-hover">
                        <td class="text-center fw-bold text-muted">{{ informe.id|stringformat:"010d" }}</td>
                        <td>{{ informe.titulo|truncatewords:5 }}</td>
                        <td>
                            {% if informe.empleado %}
                                {{ informe.empleado.apellido }}, {{ informe.empleado.nombre }}
                            {% else %}
                                <span class="text-muted">Sin empleado</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark">{{ informe.bus.ficha }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ informe.sucursal.abreviatura }}</span>
                        </td>
                        <td class="text-center small">{{ informe.fecha_hora|date:"d/m/Y H:i" }}</td>
                        <td>
                            <div class="d-flex gap-1 justify-content-center flex-wrap">
                                <a href="{% url 'informes:editar_informe' informe.pk %}?next={{ request.path }}"
                                   class="btn btn-sm btn-pastel-orange" title="Editar informe">
                                    <i class="bi bi-pencil"></i>
                                </a>

                                <a href="{% url 'informes:cargar_fotos' informe.pk %}?next={{ request.path }}"
                                   class="btn btn-sm btn-pastel-pink" title="Gestionar imágenes">
                                    <i class="bi bi-image"></i> {{ informe.fotos.count }}
                                </a>

                                <a href="{% url 'informes:cargar_video' informe.pk %}?next={{ request.path }}"
                                   class="btn btn-sm btn-pastel-cyan" title="Gestionar videos">
                                    <i class="bi bi-camera-video"></i> {{ informe.videos.count }}
                                </a>

                                <a href="{% url 'informes:enviar_informe_email' informe.pk %}?next={{ request.get_full_path }}"
                                   class="btn btn-sm btn-pastel-purple" title="Enviar por correo">
                                    <i class="bi bi-envelope"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No se encontraron informes con los filtros aplicados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">

                {% if page_obj.number > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&filtro={{ request.GET.filtro }}&fecha_desde={{ request.GET.fecha_desde }}&fecha_hasta={{ request.GET.fecha_hasta }}&sucursal={{ request.GET.sucursal }}&legajo={{ request.GET.legajo }}&numero_ficha={{ request.GET.numero_ficha }}&origen={{ request.GET.origen }}" aria-label="Primero">
                        <i class="bi bi-chevron-bar-left"></i>
                    </a>
                </li>
                {% endif %}

                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&filtro={{ request.GET.filtro }}&fecha_desde={{ request.GET.fecha_desde }}&fecha_hasta={{ request.GET.fecha_hasta }}&sucursal={{ request.GET.sucursal }}&legajo={{ request.GET.legajo }}&numero_ficha={{ request.GET.numero_ficha }}&origen={{ request.GET.origen }}" aria-label="Anterior">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&filtro={{ request.GET.filtro }}&fecha_desde={{ request.GET.fecha_desde }}&fecha_hasta={{ request.GET.fecha_hasta }}&sucursal={{ request.GET.sucursal }}&legajo={{ request.GET.legajo }}&numero_ficha={{ request.GET.numero_ficha }}&origen={{ request.GET.origen }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&filtro={{ request.GET.filtro }}&fecha_desde={{ request.GET.fecha_desde }}&fecha_hasta={{ request.GET.fecha_hasta }}&sucursal={{ request.GET.sucursal }}&legajo={{ request.GET.legajo }}&numero_ficha={{ request.GET.numero_ficha }}&origen={{ request.GET.origen }}" aria-label="Siguiente">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}

                {% if page_obj.number < page_obj.paginator.num_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&filtro={{ request.GET.filtro }}&fecha_desde={{ request.GET.fecha_desde }}&fecha_hasta={{ request.GET.fecha_hasta }}&sucursal={{ request.GET.sucursal }}&legajo={{ request.GET.legajo }}&numero_ficha={{ request.GET.numero_ficha }}&origen={{ request.GET.origen }}" aria-label="Último">
                        <i class="bi bi-chevron-bar-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
</div>

<style>
/* Botones con colores pastel */
.btn-pastel-green {
    background-color: #a8e6cf;
    border-color: #88d4ab;
    color: #2d5f3f;
    font-weight: 500;
}

.btn-pastel-green:hover {
    background-color: #88d4ab;
    border-color: #6fc490;
    color: #2d5f3f;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(136, 212, 171, 0.3);
}

.btn-pastel-orange {
    background-color: #ffd4a3;
    border-color: #ffbe7a;
    color: #8b5a00;
    font-weight: 500;
}

.btn-pastel-orange:hover {
    background-color: #ffbe7a;
    border-color: #ffa952;
    color: #8b5a00;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(255, 190, 122, 0.3);
}

.btn-pastel-pink {
    background-color: #ffd4e5;
    border-color: #ffb8d4;
    color: #8b004b;
    font-weight: 500;
}

.btn-pastel-pink:hover {
    background-color: #ffb8d4;
    border-color: #ff9cc3;
    color: #8b004b;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(255, 180, 212, 0.3);
}

.btn-pastel-cyan {
    background-color: #b3e5fc;
    border-color: #81d4fa;
    color: #01579b;
    font-weight: 500;
}

.btn-pastel-cyan:hover {
    background-color: #81d4fa;
    border-color: #4fc3f7;
    color: #01579b;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(129, 212, 250, 0.3);
}

.btn-pastel-purple {
    background-color: #e1bee7;
    border-color: #ce93d8;
    color: #4a148c;
    font-weight: 500;
}

.btn-pastel-purple:hover {
    background-color: #ce93d8;
    border-color: #ba68c8;
    color: #4a148c;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(206, 147, 216, 0.3);
}

.btn-pastel-blue {
    background-color: #bbdefb;
    border-color: #90caf9;
    color: #0d47a1;
    font-weight: 500;
}

.btn-pastel-blue:hover {
    background-color: #90caf9;
    border-color: #64b5f6;
    color: #0d47a1;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(144, 202, 249, 0.3);
}

.btn-pastel-red {
    background-color: #ffcdd2;
    border-color: #ef9a9a;
    color: #b71c1c;
    font-weight: 500;
}

.btn-pastel-red:hover {
    background-color: #ef9a9a;
    border-color: #e57373;
    color: #b71c1c;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 154, 154, 0.3);
}

/* Transiciones suaves para todos los botones pastel */
[class*="btn-pastel-"] {
    transition: all 0.2s ease;
}

/* Header de tabla con color pastel */
.table-header-pastel {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    color: #2e7d32;
}

.table-header-pastel th {
    font-weight: 600;
    font-size: 0.9rem;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid #a5d6a7;
}

/* Hover effect en filas */
.table-row-hover:hover {
    background-color: #f5f5f5;
    transition: background-color 0.2s ease;
}

/* Cards más suaves */
.card {
    border-radius: 0.5rem;
}

/* Paginación más moderna */
.pagination .page-link {
    border-radius: 0.3rem;
    margin: 0 0.2rem;
    color: #546e7a;
    border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: #a8e6cf;
    border-color: #88d4ab;
    color: #2d5f3f;
}

.pagination .page-link:hover {
    background-color: #e8f5e9;
    border-color: #a5d6a7;
    color: #2e7d32;
}

/* Inputs y selects más modernos */
.form-control-sm, .form-select-sm {
    border-radius: 0.3rem;
    border-color: #dee2e6;
}

.form-control-sm:focus, .form-select-sm:focus {
    border-color: #a8e6cf;
    box-shadow: 0 0 0 0.2rem rgba(168, 230, 207, 0.25);
}

/* Alert más suave */
.alert-info {
    background-color: #e3f2fd;
    border-color: #90caf9;
    color: #0d47a1;
}

/* Etiquetas de filtros adaptables a modo claro y oscuro */
.filter-label {
    color: #6c757d;
    font-weight: 500;
}

/* Modo oscuro */
@media (prefers-color-scheme: dark) {
    .filter-label {
        color: #adb5bd !important;
    }

    .card {
        background-color: #212529;
        border-color: #495057;
    }

    .table-header-pastel {
        background: linear-gradient(135deg, #2d3e2f 0%, #1e3a1e 100%);
        color: #a8e6cf;
    }

    .table-header-pastel th {
        border-bottom-color: #4a5f4a;
    }

    .table-row-hover:hover {
        background-color: #343a40;
    }
}

/* Modo oscuro con atributo data-bs-theme */
[data-bs-theme="dark"] .filter-label {
    color: #adb5bd !important;
}

[data-bs-theme="dark"] .card {
    background-color: #212529;
    border-color: #495057;
}

[data-bs-theme="dark"] .table-header-pastel {
    background: linear-gradient(135deg, #2d3e2f 0%, #1e3a1e 100%);
    color: #a8e6cf;
}

[data-bs-theme="dark"] .table-header-pastel th {
    border-bottom-color: #4a5f4a;
}

[data-bs-theme="dark"] .table-row-hover:hover {
    background-color: #343a40;
}
</style>
{% endblock %}
